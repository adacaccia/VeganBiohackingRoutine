<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Planner 2026 - Dashboard Personale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        .mono { font-family: 'Space Mono', monospace; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-text { background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .alert-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .month-card { transition: all 0.3s ease; }
        .month-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(96, 165, 250, 0.3); }
        .positive { color: #34d399; }
        .negative { color: #f87171; }
        .warning { color: #fbbf24; }
        .critical { color: #ef4444; }
        .tari-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        .chart-container { 
            position: relative; 
            height: 250px; 
            width: 100%;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold gradient-text mb-2">Finance Planner 2026</h1>
                <p class="text-slate-400 text-sm">Gestione completa del tuo calendario finanziario</p>
            </div>
            <div class="flex gap-2">
                <button onclick="simulateScenario()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors text-sm">
                    üîÑ Simula
                </button>
                <button onclick="exportData()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition-colors text-sm">
                    üì• Esporta
                </button>
            </div>
        </div>
    </header>

    <!-- Alert Banner TARI -->
    <div class="max-w-7xl mx-auto mb-4">
        <div class="glass rounded-xl p-3 border-l-4 border-orange-500 flex items-center gap-3">
            <span class="text-xl">üèõÔ∏è</span>
            <div class="flex-1">
                <h3 class="font-bold text-orange-400 text-sm">Nuova Spesa Aggiunta: TARI 2026</h3>
                <p class="text-xs text-slate-300">2 rate da ‚Ç¨125 (Febbraio + Maggio) - Totale ‚Ç¨250/anno</p>
            </div>
            <span class="text-[10px] bg-orange-500/20 text-orange-400 px-2 py-1 rounded">AGGIORNATO</span>
        </div>
    </div>

    <!-- Critical Alert for Feb/May -->
    <div id="alertBanner" class="max-w-7xl mx-auto mb-4 hidden">
        <div class="glass rounded-xl p-3 border-l-4 border-red-500 flex items-center gap-3 alert-pulse">
            <span class="text-xl">‚ö†Ô∏è</span>
            <div>
                <h3 class="font-bold text-red-400 text-sm">Mese Super-Critico</h3>
                <p class="text-xs text-slate-300" id="alertText">Rottamazione + TARI + Picchi prestiti</p>
            </div>
        </div>
    </div>

    <!-- Compact KPI Cards -->
    <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <div class="glass rounded-xl p-4">
            <div class="text-slate-400 text-xs mb-1">Saldo Iniziale</div>
            <div class="text-xl font-bold mono">‚Ç¨534.94</div>
        </div>
        <div class="glass rounded-xl p-4">
            <div class="text-slate-400 text-xs mb-1">Proiezione 2026</div>
            <div class="text-xl font-bold mono positive" id="yearEndBalance">‚Ç¨3,021.14</div>
            <div class="text-[10px] text-emerald-400">‚Üë ‚Ç¨2,486 (con TARI)</div>
        </div>
        <div class="glass rounded-xl p-4">
            <div class="text-slate-400 text-xs mb-1">Media Mensile</div>
            <div class="text-xl font-bold mono">‚Ç¨207</div>
        </div>
        <div class="glass rounded-xl p-4">
            <div class="text-slate-400 text-xs mb-1">Prossimo Critico</div>
            <div class="text-lg font-bold mono critical">1 Feb</div>
            <div class="text-[10px] text-red-400">+TARI ‚Ç¨125</div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        
        <!-- Chart Section -->
        <div class="lg:col-span-2 glass rounded-xl p-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold">Andamento Saldo (con TARI)</h2>
                <div class="flex gap-1">
                    <button onclick="toggleChart('line')" class="px-2 py-1 text-xs bg-slate-700 rounded hover:bg-slate-600">Linea</button>
                    <button onclick="toggleChart('bar')" class="px-2 py-1 text-xs bg-slate-700 rounded hover:bg-slate-600">Barre</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="glass rounded-xl p-4 flex flex-col justify-between">
            <div>
                <h2 class="text-lg font-bold mb-3">Impatto TARI</h2>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-2 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                        <div>
                            <div class="text-xs text-orange-400 font-bold">TARI Rate</div>
                            <div class="text-[10px] text-slate-400">Feb + Mag</div>
                        </div>
                        <span class="mono text-sm text-orange-400">-‚Ç¨250</span>
                    </div>
                    
                    <div class="flex justify-between items-center p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-xs text-slate-300">Feb rivisto</span>
                        <span class="mono text-sm text-red-400">-‚Ç¨281</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-slate-800/50 rounded-lg">
                        <span class="text-xs text-slate-300">Mag rivisto</span>
                        <span class="mono text-sm text-red-400">-‚Ç¨38</span>
                    </div>
                    
                    <div class="pt-2 border-t border-slate-700">
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-slate-400">Nuovo minimo:</span>
                            <span class="text-red-400 font-bold">-‚Ç¨450 (Feb)</span>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="scrollToCalendar()" class="mt-4 w-full p-2 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 rounded-lg text-sm text-blue-400 transition-colors">
                Vedi Calendario ‚Üì
            </button>
        </div>
    </div>

    <!-- Monthly Grid -->
    <div class="max-w-7xl mx-auto mb-8" id="calendarSection">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span>üìÖ</span> Calendario 2026 (Aggiornato)
        </h2>
        
        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3" id="monthsGrid">
            <!-- Generated by JS -->
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass rounded-xl max-w-lg w-full max-h-[70vh] overflow-y-auto p-5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" id="modalTitle">Dettaglio</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="text-sm"></div>
        </div>
    </div>

    <script>
        // Updated data with TARI
        const financialData = {
            startingBalance: 534.94,
            tariAdded: true,
            months: [
                { name: 'Gen', fullName: 'Gennaio', balance: -168.85, net: -703.79, critical: true, hasTari: false, notes: ['Amazon Prime ‚Ç¨49,99', 'Picco prestiti'] },
                { 
                    name: 'Feb', 
                    fullName: 'Febbraio', 
                    balance: -450.09, // -325.09 - 125
                    net: -281.24, // -156.24 - 125
                    critical: true, 
                    hasTari: true,
                    tariAmount: -125,
                    notes: ['Rottamazione ‚Ç¨236', 'TARI 1¬™ rata ‚Ç¨125', 'Telepass ‚Ç¨68'] 
                },
                { name: 'Mar', fullName: 'Marzo', balance: -376.61, net: 73.48, critical: false, hasTari: false, notes: ['Recupero', 'Condominio'] },
                { name: 'Apr', fullName: 'Aprile', balance: -239.13, net: 137.48, critical: false, hasTari: false, notes: ['Trend positivo'] },
                { 
                    name: 'Mag', 
                    fullName: 'Maggio', 
                    balance: -151.84, // -26.84 - 125
                    net: -37.71, // 87.29 - 125
                    critical: true, 
                    hasTari: true,
                    tariAmount: -125,
                    notes: ['Rottamazione ‚Ç¨236', 'TARI 2¬™ rata ‚Ç¨125'] 
                },
                { name: 'Giu', fullName: 'Giugno', balance: 2045.64, net: 2197.48, critical: false, hasTari: false, notes: ['14¬™ mensilit√†!'] },
                { name: 'Lug', fullName: 'Luglio', balance: 2369.12, net: 323.48, critical: false, hasTari: false, notes: ['Continuit√†'] },
                { name: 'Ago', fullName: 'Agosto', balance: 2100.41, net: -268.71, critical: true, hasTari: false, notes: ['Rottamazione ‚Ç¨236'] },
                { name: 'Set', fullName: 'Settembre', balance: 1743.89, net: -356.52, critical: false, hasTari: false, notes: ['Doppia spesa'] },
                { name: 'Ott', fullName: 'Ottobre', balance: 1711.37, net: -32.52, critical: false, hasTari: false, notes: ['Quasi pareggio'] },
                { name: 'Nov', fullName: 'Novembre', balance: 1118.66, net: -592.71, critical: true, hasTari: false, notes: ['Rottamazione ‚Ç¨236'] },
                { name: 'Dic', fullName: 'Dicembre', balance: 3146.14, net: 2027.48, critical: false, hasTari: false, notes: ['13¬™ mensilit√†!'] }
            ]
        };

        let chartInstance;
        
        function initChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const labels = financialData.months.map(m => m.name);
            const data = financialData.months.map(m => m.balance);
            
            // Highlight TARI months
            const pointColors = data.map((v, i) => {
                if (financialData.months[i].hasTari) return '#f59e0b'; // Orange for TARI
                return v < 0 ? '#ef4444' : '#10b981';
            });
            
            const pointRadii = data.map((v, i) => {
                if (financialData.months[i].hasTari) return 6; // Bigger for TARI
                return 4;
            });
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Saldo (‚Ç¨)',
                        data: data,
                        borderColor: '#60a5fa',
                        backgroundColor: (ctx) => {
                            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 250);
                            gradient.addColorStop(0, 'rgba(96, 165, 250, 0.3)');
                            gradient.addColorStop(1, 'rgba(96, 165, 250, 0.0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: pointColors,
                        pointRadius: pointRadii,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: 1,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 8,
                            cornerRadius: 6,
                            titleFont: { size: 12 },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: (ctx) => {
                                    const month = financialData.months[ctx.dataIndex];
                                    let label = `‚Ç¨${ctx.raw.toFixed(0)}`;
                                    if (month.hasTari) label += ' (con TARI)';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                callback: (val) => '‚Ç¨' + val,
                                color: '#94a3b8',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function toggleChart(type) {
            if (chartInstance) {
                chartInstance.config.type = type;
                chartInstance.update('none');
            }
        }

        function generateMonthCards() {
            const grid = document.getElementById('monthsGrid');
            
            grid.innerHTML = financialData.months.map((month, idx) => {
                const isNegative = month.net < 0;
                const isCritical = month.critical;
                const hasTari = month.hasTari;
                
                let borderColor = 'border-slate-700';
                if (hasTari) borderColor = 'border-orange-500/50';
                else if (isCritical) borderColor = 'border-red-500/50';
                
                const tariBadge = hasTari ? 
                    '<span class="absolute -top-2 -right-2 w-6 h-6 tari-badge rounded-full flex items-center justify-center text-[10px] font-bold text-white" title="TARI">T</span>' : '';
                
                return `
                    <div class="month-card glass rounded-lg p-3 border ${borderColor} cursor-pointer hover:bg-slate-800/50 relative" 
                         onclick="showMonthDetail(${idx})">
                        ${tariBadge}
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-sm">${month.fullName}</span>
                            ${isCritical && !hasTari ? '<span class="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded">!</span>' : ''}
                        </div>
                        
                        <div class="space-y-1">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-400">Netto:</span>
                                <span class="mono font-bold ${isNegative ? 'negative' : 'positive'}">
                                    ${month.net > 0 ? '+' : ''}‚Ç¨${month.net.toFixed(0)}
                                </span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-400">Cumulato:</span>
                                <span class="mono ${month.balance < 0 ? 'negative' : 'positive'}">
                                    ‚Ç¨${month.balance.toFixed(0)}
                                </span>
                            </div>
                        </div>

                        <div class="mt-2 pt-2 border-t border-slate-700/50 text-[10px] text-slate-500 truncate">
                            ${month.notes[0]}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showMonthDetail(monthIndex) {
            const month = financialData.months[monthIndex];
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            title.textContent = `${month.fullName} 2026`;
            
            const criticalDates = getCriticalDatesForMonth(monthIndex);
            
            // TARI special section
            const tariSection = month.hasTari ? `
                <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">üèõÔ∏è</span>
                        <span class="font-bold text-orange-400">TARI - Tassa Rifiuti</span>
                    </div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-slate-300">Rata ${month.fullName === 'Febbraio' ? '1¬™' : '2¬™'}:</span>
                        <span class="mono text-orange-400 font-bold">‚Ç¨${Math.abs(month.tariAmount)}</span>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-2">
                        Scadenza: entro fine ${month.fullName}. Bollettino postale o PagoPA.
                    </div>
                </div>
            ` : '';
            
            content.innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-800/50 p-3 rounded-lg">
                        <div class="text-slate-400 text-xs mb-1">Entrate</div>
                        <div class="text-lg font-bold text-emerald-400 mono">‚Ç¨${getIncomeForMonth(monthIndex).toFixed(0)}</div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-lg">
                        <div class="text-slate-400 text-xs mb-1">Uscite</div>
                        <div class="text-lg font-bold text-red-400 mono">‚Ç¨${Math.abs(month.net - getIncomeForMonth(monthIndex)).toFixed(0)}</div>
                    </div>
                </div>

                ${tariSection}

                <h3 class="font-bold mb-2 text-sm">Date Critiche</h3>
                <div class="space-y-1.5 mb-4">
                    ${criticalDates.map(date => `
                        <div class="flex items-center justify-between p-2 bg-slate-800/30 rounded text-xs ${date.isTari ? 'border-l-2 border-orange-500' : ''}">
                            <div class="flex items-center gap-2">
                                <span class="w-8 text-center font-bold ${date.isTari ? 'text-orange-400' : 'text-blue-400'}">${date.day}</span>
                                <span class="text-slate-300">${date.desc}</span>
                            </div>
                            <span class="mono ${date.amount < 0 ? 'text-red-400' : 'text-emerald-400'}">
                                ${date.amount > 0 ? '+' : ''}‚Ç¨${Math.abs(date.amount).toFixed(0)}
                            </span>
                        </div>
                    `).join('')}
                </div>

                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-xs">
                    <span class="font-bold text-blue-400">üí° </span>
                    <span class="text-slate-300">${getStrategyTip(month)}</span>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function getCriticalDatesForMonth(idx) {
            const month = financialData.months[idx];
            const baseDates = [
                { day: '1¬∞', desc: 'Santander + Subbyx', amount: -780, isTari: false },
                { day: '15', desc: 'Fineco + Compass', amount: -820, isTari: false },
                { day: '27', desc: 'Stipendio', amount: 2345, isTari: false }
            ];
            
            // Add TARI if applicable
            if (month.hasTari) {
                baseDates.push({ 
                    day: '30', 
                    desc: 'TARI Rata', 
                    amount: month.tariAmount, 
                    isTari: true 
                });
            }
            
            if ([1, 4, 7, 10].includes(idx)) {
                baseDates.push({ day: '25-3', desc: 'Rottamazione', amount: -236, isTari: false });
            }
            
            if (idx === 5) baseDates.push({ day: '27', desc: '14¬™ mensilit√†', amount: 2230, isTari: false });
            if (idx === 11) baseDates.push({ day: '27', desc: '13¬™ mensilit√†', amount: 2230, isTari: false });
            
            return baseDates.sort((a, b) => parseInt(a.day) - parseInt(b.day));
        }

        function getIncomeForMonth(idx) {
            let base = 2345;
            if (idx === 5) base += 2230;
            if (idx === 11) base += 2230;
            return base;
        }

        function getStrategyTip(month) {
            if (month.hasTari) return "‚ö†Ô∏è Mese con TARI: aumenta buffer a ‚Ç¨1.200. Paga entro fine mese per mora!";
            if (month.balance < -300) return "Mese critico: mantieni buffer ‚Ç¨1.050. Evita spese C.";
            if (month.net > 1000) return "Mese positivo: accumula riserva o anticipa prestiti.";
            if (month.critical) return "Attenzione zona rossa 25-3. Non scendere sotto ‚Ç¨250.";
            return "Mese standard: buffer ‚Ç¨800 (1¬∞) e ‚Ç¨1.000 (15).";
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function simulateScenario() {
            const msg = financialData.tariAdded ? 
                "TARI gi√† inclusa!\n\nProssime scadenze:\n‚Ä¢ 28 Feb: TARI 1¬™ rata ‚Ç¨125\n‚Ä¢ 31 Mag: TARI 2¬™ rata ‚Ç¨125" :
                "Aggiungi TARI?";
            alert(msg);
        }

        function exportData() {
            const data = JSON.stringify(financialData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'finance_2026_con_TARI.json';
            a.click();
        }

        function scrollToCalendar() {
            document.getElementById('calendarSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Check for critical months (Feb/May)
        function checkAlerts() {
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-11
            
            if (financialData.months[currentMonth]?.hasTari) {
                document.getElementById('alertBanner').classList.remove('hidden');
                document.getElementById('alertText').textContent = 
                    `${financialData.months[currentMonth].fullName}: Rottamazione + TARI ‚Ç¨125!`;
            }
        }

        window.onload = () => {
            initChart();
            generateMonthCards();
            checkAlerts();
        };

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && chartInstance) {
                chartInstance.stop();
            } else if (chartInstance) {
                chartInstance.start();
            }
        });

        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detailModal')) closeModal();
        });
    </script>
</body>
</html>
