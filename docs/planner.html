<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Planner 2026 - Vista Reale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        .mono { font-family: 'Space Mono', monospace; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-text { background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .drop-zone { border: 2px dashed #475569; transition: all 0.3s; }
        .drop-zone.dragover { border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
        .file-chip { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-pagato { color: #10b981; }
        .status-da-pagare { color: #ef4444; font-weight: bold; }
        .status-futuro { color: #64748b; }
        .bg-scaduto { background: rgba(239, 68, 68, 0.1); }
        .bg-futuro { background: rgba(100, 116, 139, 0.05); opacity: 0.6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <header class="max-w-7xl mx-auto mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold gradient-text">Finance Planner 2026</h1>
                <p class="text-slate-400 text-sm">Solo numeri, niente fronzoli</p>
            </div>
            <button onclick="resetAll()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm hidden" id="resetBtn">
                ðŸ”„ Reset
            </button>
        </div>
    </header>

    <!-- Upload -->
    <div class="max-w-7xl mx-auto mb-6" id="uploadSection">
        <div id="dropZone" class="drop-zone rounded-xl p-8 text-center cursor-pointer mb-4" 
             onclick="document.getElementById('csvInput').click()"
             ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <div class="text-4xl mb-3">ðŸ“‚</div>
            <h3 class="text-lg font-bold mb-2">Carica CSV</h3>
            <p class="text-sm text-slate-400">Febbraio o qualsiasi mese</p>
        </div>
        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
        <div id="fileList" class="flex flex-wrap gap-2 mb-4 hidden"></div>
        <button id="processBtn" onclick="processFile()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-bold hidden">
            Analizza
        </button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="max-w-7xl mx-auto hidden">
        
        <!-- KPI Essenziali -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="glass rounded-xl p-4">
                <div class="text-slate-400 text-xs mb-1">Entrate</div>
                <div class="text-xl font-bold mono text-emerald-400" id="kpiIncome">â‚¬0</div>
            </div>
            <div class="glass rounded-xl p-4">
                <div class="text-slate-400 text-xs mb-1">Uscite</div>
                <div class="text-xl font-bold mono text-red-400" id="kpiExpense">â‚¬0</div>
            </div>
            <div class="glass rounded-xl p-4">
                <div class="text-slate-400 text-xs mb-1">Saldo Netto</div>
                <div class="text-xl font-bold mono" id="kpiNet">â‚¬0</div>
            </div>
            <div class="glass rounded-xl p-4">
                <div class="text-slate-400 text-xs mb-1">GiÃ  Pagato</div>
                <div class="text-xl font-bold mono text-emerald-600" id="kpiPaid">â‚¬0</div>
            </div>
        </div>

        <!-- La veritÃ  -->
        <div class="glass rounded-xl p-4 mb-6 border-l-4 border-orange-500 bg-orange-500/5">
            <div class="flex justify-between items-center mb-2">
                <span class="text-orange-400 font-bold">DisponibilitÃ  reale dopo paghi il 27:</span>
                <span class="text-2xl font-bold mono text-orange-400" id="realGap">â‚¬0</span>
            </div>
            <p class="text-xs text-slate-400">Stipendio - (Rottamazione + TARI + Prestiti automatici) = quello che resta davvero</p>
        </div>

        <!-- Coda Prioritaria -->
        <div class="glass rounded-xl p-4 mb-6">
            <h2 class="text-lg font-bold mb-3 text-slate-300">Coda 27 Febbraio</h2>
            <div class="space-y-2" id="priorityQueue"></div>
        </div>

        <!-- Tabella Completa -->
        <div class="glass rounded-xl overflow-hidden">
            <div class="p-3 bg-slate-800 border-b border-slate-700">
                <h3 class="font-bold text-sm">Tutte le operazioni</h3>
            </div>
            <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-800 sticky top-0">
                        <tr>
                            <th class="text-left p-3 text-xs">Data</th>
                            <th class="text-left p-3 text-xs">Voce</th>
                            <th class="text-right p-3 text-xs">Importo</th>
                            <th class="text-center p-3 text-xs">Stato</th>
                        </tr>
                    </thead>
                    <tbody id="monthTable" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let allData = [];
        const TODAY = new Date('2026-02-20');

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                currentFile = e.dataTransfer.files[0];
                showFile();
            }
        }

        function handleFileSelect(e) {
            if (e.target.files[0]) {
                currentFile = e.target.files[0];
                showFile();
            }
        }

        function showFile() {
            document.getElementById('fileList').classList.remove('hidden');
            document.getElementById('processBtn').classList.remove('hidden');
            document.getElementById('fileList').innerHTML = `
                <div class="file-chip glass px-3 py-1.5 rounded-lg text-sm border border-slate-700">
                    <span class="text-emerald-400">ðŸ“„</span> ${currentFile.name}
                </div>
            `;
        }

        async function processFile() {
            if (!currentFile) return;
            
            const text = await currentFile.text();
            parseCSV(text);
            
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('resetBtn').classList.remove('hidden');
            
            showData();
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            allData = [];
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                if (line.includes('FEBRUARY') || line.includes('Spese effettuate') || 
                    line.includes('Saldo netto') || line.includes('Saldo cumulato') || 
                    line.startsWith(';;')) continue;
                
                const delimiter = (line.match(/;/g) || []).length > (line.match(/,/g) || []).length ? ';' : ',';
                const values = line.split(delimiter).map(v => v.trim());
                
                if (values.length < 6) continue;
                
                const data = values[0];
                if (!data.match(/^\d{1,2}[\/\-\.]\d{1,2}/)) continue;
                
                const categoria = values[1];
                const voce = values[2];
                
                let importoStr = values[3].replace('â‚¬', '').replace('(', '').replace(')', '');
                if (importoStr.includes(',') && !importoStr.includes('.')) {
                    importoStr = importoStr.replace(',', '.');
                } else if (importoStr.includes(',') && importoStr.includes('.')) {
                    importoStr = importoStr.replace(/\./g, '').replace(',', '.');
                }
                const importo = parseFloat(importoStr) || 0;
                
                const metodo = values[4];
                const pagatoRaw = values[7] || values[8] || '';
                
                let status;
                if (pagatoRaw.toLowerCase() === 'sÃ¬' || pagatoRaw.toLowerCase() === 'si') {
                    status = 'pagato';
                } else {
                    const day = parseInt(data.split(/[\/\-\.]/)[0]);
                    status = day < 20 ? 'scaduto' : 'da-pagare'; // Semplificato
                }
                
                allData.push({
                    data, categoria, voce, importo, metodo, status,
                    giorno: parseInt(data.split(/[\/\-\.]/)[0]) || 1,
                    isCritical: voce.toLowerCase().includes('rottamazione') || 
                               voce.toLowerCase().includes('tari') ||
                               categoria === 'Prestito'
                });
            }
        }

        function showData() {
            const income = allData.filter(d => d.importo > 0).reduce((s, d) => s + d.importo, 0);
            const expenses = allData.filter(d => d.importo < 0);
            const totalExpense = Math.abs(expenses.reduce((s, d) => s + d.importo, 0));
            const paid = expenses.filter(d => d.status === 'pagato').reduce((s, d) => s + Math.abs(d.importo), 0);
            const net = income - totalExpense;

            document.getElementById('kpiIncome').textContent = `â‚¬${income.toFixed(0)}`;
            document.getElementById('kpiExpense').textContent = `â‚¬${totalExpense.toFixed(0)}`;
            document.getElementById('kpiNet').textContent = `â‚¬${net.toFixed(0)}`;
            document.getElementById('kpiNet').className = `text-xl font-bold mono ${net >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
            document.getElementById('kpiPaid').textContent = `â‚¬${paid.toFixed(0)}`;

            // Calcolo "disponibilitÃ  reale"
            // Stipendio - (Rottamazione + TARI + Prestiti che addebitano automaticamente)
            const stipendio = income;
            const rottamazione = Math.abs(allData.find(d => d.voce.includes('Rottamazione'))?.importo || 0);
            const tari = Math.abs(allData.find(d => d.voce.includes('TARI'))?.importo || 0);
            const santander = Math.abs(allData.find(d => d.voce.includes('Santander'))?.importo || 0);
            const compassAuto = Math.abs(allData.find(d => d.voce.includes('Compass prestito auto'))?.importo || 0);
            
            const bloccati = rottamazione + tari + santander + compassAuto; // Questi non si possono evitare
            const residuo = stipendio - bloccati;
            
            document.getElementById('realGap').textContent = `â‚¬${residuo.toFixed(0)}`;
            document.getElementById('realGap').className = `text-2xl font-bold mono ${residuo >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

            // Coda prioritaria (solo non pagati, ordinati per giorno)
            const daPagare = allData.filter(d => d.importo < 0 && d.status !== 'pagato').sort((a, b) => a.giorno - b.giorno);
            
            document.getElementById('priorityQueue').innerHTML = daPagare.map(d => {
                const isCritical = d.isCritical;
                return `
                    <div class="flex justify-between items-center p-2 ${isCritical ? 'bg-red-500/10 border-l-2 border-red-500' : 'bg-slate-800/30'} rounded">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-500 font-mono">${d.data}</span>
                            <span class="text-sm ${isCritical ? 'text-red-300 font-semibold' : 'text-slate-300'}">
                                ${d.voce.substring(0, 30)}${d.voce.length > 30 ? '...' : ''}
                            </span>
                        </div>
                        <span class="mono font-bold ${isCritical ? 'text-red-400' : 'text-slate-400'}">
                            â‚¬${Math.abs(d.importo).toFixed(0)}
                        </span>
                    </div>
                `;
            }).join('');

            // Tabella completa
            const sorted = [...allData].sort((a, b) => a.giorno - b.giorno);
            document.getElementById('monthTable').innerHTML = sorted.map(d => {
                let rowClass = '';
                if (d.status === 'pagato') rowClass = 'opacity-40';
                else if (d.giorno <= 20) rowClass = 'bg-scaduto';
                else rowClass = 'bg-futuro';
                
                const icon = d.status === 'pagato' ? 'âœ“' : (d.giorno <= 20 ? '!' : 'â—‹');
                const color = d.status === 'pagato' ? 'text-emerald-400' : (d.giorno <= 20 ? 'text-red-400' : 'text-slate-500');
                
                return `
                    <tr class="${rowClass}">
                        <td class="p-3 text-xs font-mono text-slate-400">${d.data}</td>
                        <td class="p-3 text-sm text-slate-300">${d.voce.substring(0, 40)}</td>
                        <td class="p-3 text-right mono font-bold ${d.importo < 0 ? 'text-red-400' : 'text-emerald-400'}">
                            ${d.importo > 0 ? '+' : ''}â‚¬${Math.abs(d.importo).toFixed(2)}
                        </td>
                        <td class="p-3 text-center ${color}">${icon}</td>
                    </tr>
                `;
            }).join('');
        }

        function resetAll() {
            currentFile = null;
            allData = [];
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('fileList').classList.add('hidden');
            document.getElementById('processBtn').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('resetBtn').classList.add('hidden');
            document.getElementById('csvInput').value = '';
        }

        window.onload = () => {};
    </script>
</body>
</html>
